name: Backend Signer Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  push:
    branches:
      - main
    paths:
      - 'backend-signer/**'
      - '.github/workflows/backend-signer-deploy.yml'

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'staging' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    environment:
      name: staging
      url: https://staging-backend-signer.yielddelta.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli@latest

      - name: Deploy to Railway (Staging)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_STAGING }}
        run: |
          cd backend-signer
          railway up --service backend-signer-staging
        continue-on-error: true

      - name: Deploy to Vercel (Alternative)
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_BACKEND_STAGING }}
        run: |
          cd backend-signer
          npm install -g vercel
          vercel deploy --token=$VERCEL_TOKEN --prod --yes
        continue-on-error: true

      - name: Health Check
        run: |
          sleep 30
          curl -f https://staging-backend-signer.yielddelta.com/health || echo "Health check failed"
        continue-on-error: true

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://backend-signer.yielddelta.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'

      - name: Install dependencies
        run: |
          cd backend-signer
          npm ci

      - name: Build application
        run: |
          cd backend-signer
          npm run build

      - name: Deploy to Production Server
        env:
          DEPLOY_HOST: ${{ secrets.PROD_HOST }}
          DEPLOY_USER: ${{ secrets.PROD_USER }}
          DEPLOY_KEY: ${{ secrets.PROD_SSH_KEY }}
          DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
        run: |
          # Create SSH key file
          echo "$DEPLOY_KEY" > deploy_key
          chmod 600 deploy_key

          # Create deployment script
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e

          # Navigate to deployment directory
          cd $DEPLOY_PATH/backend-signer

          # Pull latest code
          git pull origin main

          # Install dependencies
          npm ci --production

          # Build application
          npm run build

          # Restart service
          pm2 restart backend-signer || pm2 start dist/index.js --name backend-signer

          # Save PM2 configuration
          pm2 save

          echo "Deployment completed successfully"
          EOF

          # Execute deployment
          ssh -i deploy_key -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST 'bash -s' < deploy.sh

          # Cleanup
          rm -f deploy_key deploy.sh
        continue-on-error: true

      - name: Deploy to Kubernetes
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          # Setup kubectl
          echo "$KUBE_CONFIG" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

          # Apply deployment
          kubectl apply -f backend-signer/k8s/ -n production

          # Wait for rollout
          kubectl rollout status deployment/backend-signer -n production

          # Cleanup
          rm -f kubeconfig
        continue-on-error: true

      - name: Notify Deployment
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Backend Signer deployed to ${{ github.event.inputs.environment || "staging" }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
        continue-on-error: true

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.event.inputs.environment == 'production'
    needs: deploy-production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.before }}

      - name: Rollback Production
        env:
          DEPLOY_HOST: ${{ secrets.PROD_HOST }}
          DEPLOY_USER: ${{ secrets.PROD_USER }}
          DEPLOY_KEY: ${{ secrets.PROD_SSH_KEY }}
        run: |
          echo "$DEPLOY_KEY" > deploy_key
          chmod 600 deploy_key

          ssh -i deploy_key -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            cd /var/www/backend-signer
            git checkout HEAD~1
            npm ci --production
            npm run build
            pm2 restart backend-signer
          EOF

          rm -f deploy_key
        continue-on-error: true

      - name: Notify Rollback
        uses: 8398a7/action-slack@v3
        with:
          status: 'warning'
          text: 'Backend Signer deployment rolled back due to failure'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true